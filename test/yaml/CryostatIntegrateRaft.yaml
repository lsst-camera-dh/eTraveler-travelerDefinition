%YAML  1.1
---
Name: Cryostat_integrate_raft
HardwareType: Cryostat
Description: Install prepared raft into prepared cryostat
Sequence:
   -
     Name: Attach Z-stage to raft
     Description: something goes here
     Prerequisites:
       -
         Name: LCA-Raft_2
         PrerequisiteType: COMPONENT
         #Status: raft_aligned
       -
         Name: Cryostat_integrate_raft_prepare
         Version: 1
         PrerequisiteType: PROCESS_STEP
   -
     Name: Draw raft into bay
     Description:  something goes here
   -
     Name: Keyence supported alignment
     Description:  Has substeps.  Details omitted here
   -
     Name: Alignment-movement-cm 
     Description: Initial coarse placement
     MaxIteration:  10 # or whatever is reasonable
     Sequence:
        - 
          Name: Align-cm
          Description: For each movement check if still aligned
          MaxIteration: 3 # or whatever is reasonable
          Sequence:
             -
                Name: 1cm up
                Description: Move raft up 1 cm
             -
                Name: Keyence alignement check
                Description:  Will have substeps. Details omitted here
             -
                Name: aligned decision
                Selection:
                   - 
                     Name: raft aligned
                     Condition: aligned
                     Description: Operator selects this if check passed
                   -
                     Name: raft not aligned
                     Condition: alignment failure
                     Description: select if check fails
                     Sequence:
                        -
                          Name: 1cm down
                          Description: move raft back down ~ 1 cm
                        -
                          Clone: Keyence supported alignment
                        -
                          Name: need retry
                          Description:  Operator should mark failed
                          # This will return us to Align-cm step
        -
          Name: high enough decision
          Description: is back of RTM within 3 cm of sensor plane? 
          # if operator marks 'succeeded', continue
          # if marked 'failed', returns to retry of Alignment-movement-cm
   -
     Name: Microscope alignment check
     Description:  In reality a procedure with substeps
   -
     Name: Raft alignment-movement mm
     Description: Move, align until balls are fully engaged
     MaxIteration: 10 # or whatever is reasonable
     Sequence:
         -
           Name: Align-mm
           Description: Subprocedure leading to ball engagement
           MaxIteration: 3
           Sequence:
              - 
                Name: Move raft up 1mm
              -
                Clone: Microscope alignment check
              -
                Name: Check clearance
                Selection:
                   -
                     Name: clearance check passed
                     Condition: passed 
                     Description: operator marks step "succeeded"
                   -
                     Name: clearance check failed
                     Condition: failed
                     Description: tweak and try again
                     Sequence:
                        -
                          Name: move raft about 1mm down
                        -
                          Name: microscope supported tweaks
                          Description: Actually a procedure with substeps
                        -
                          Clone: Microscope alignment check
                        -
                          Name: Alignment succeeded?
                          Description: If not, mark failed. 
                          # will go to Align-mm and retry if retries left
         -
           Name: Ball engagement check
           Description: A procedure with substeps, omitted for now
         -
           Name: Ball engagement decision
           Description: Operator marks step success or failure, accordingly
           # If failure, will attempt retry at Raft alignment-movement mm
   -
      Name: Locate REB vertically
      MaxIteration:   10 # or whatever is reasonable
      Sequence:
        -
          Name: Pull REB up 
          Description: Pull up 5 mm or less
        -
          Name: check location
          Description: If has not reached cryo plate, mark "fail"
   -
      Name: Attach REB to cryo plate
      Description:  Attach with N screws
   -
      Name: Engage RAFT load transfer to grid
      Description:  Really a procedure in its own right
      